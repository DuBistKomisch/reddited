<!DOCTYPE html>
<html>
  <head>
    <!--
      Changes by Jake Barnes <jakebarnes.com.au>
      2012-09-25:
       - [fix] localStorage is actually cleared on load
      2012-06-24:
       - listSorting preference added
      2012-01-28:
       - fetches user modhash to enable voting
      2012-01-21:
       - [fix] escapes ampersands in URLs before fetching information so that pages with query strings work
       - [fix] moved title to end of data string to avoid needing to use a delimiter as the end
       - added badge content preference
      2011-11-09:
       - popup height left to default
       - clears all localStorage on load
       - badge displays number of posts of the URL, rather than comments or score
       - reload timeout lowered to 2 minutes
       - [fix] reddit's created_utc is in seconds, converted to milliseconds for JS's Date
       - [fix] changed to | for delimiter, so that links with titles containing ; don't mess up
       - added likes field to data
       - localStorage has url as key to the number of posts, then i|url as key to the data for each post with i=0..n-1
    -->
    <title>reddited</title>
    <script type="text/javascript">
      /* initialise plugin by adding popup button */
      var reddited = null;
      window.addEventListener("load", function() {
        reddited = opera.contexts.toolbar.createItem({
          disabled: true,
          title: "reddited",
          icon: "reddited_18.png",
          popup:{
            href: "popup.html",
            width: "500px"
          },
          badge: {
            backgroundColor: "#336699",
            color: "#fff",
            display: 'none'
          }
        });
        opera.contexts.toolbar.addItem(reddited);
        window.localStorage.clear();
      }, false);
      
      /* update the number on the button */
      function updateBadge(url)
      {
        var data = window.localStorage.getItem(url);
        window.localStorage.setItem("currentTab", url);
        if (data)
        {
          data = data.split("|");
          switch (widget.preferences.badgeContent) {
            case "commentsTotal":
              reddited.badge.textContent = data[5];
              break;
            case "scoreTotal":
              reddited.badge.textContent = data[4];
              break;
            case "comments":
              reddited.badge.textContent = data[3];
              break;
            case "score":
              reddited.badge.textContent = data[2];
              break;
            case "submissions":
              reddited.badge.textContent = data[0];
              break;
            default:
            case "nothing":
              reddited.badge.textContent = "";
              break;
          }
          reddited.badge.display = (data[0] != "0" && widget.preferences.badgeContent != "nothing") ? "block" : "none";
          
          // should we fetch the data again?
          if (Date.now() - data[1] < 1000 * widget.preferences.cacheTime)
            return true;
        }
        return false;
      }
      
      /* fetch data if necessary */
      opera.extension.tabs.addEventListener("blur", toggleIfExists, false);
      opera.extension.tabs.addEventListener("focus", toggleIfExists, false);
      opera.extension.addEventListener("message", toggleIfExists, false);
      function toggleIfExists()
      {
        var tab = opera.extension.tabs.getFocused();
        if (tab)
        {
          reddited.disabled = false;
          if (updateBadge(tab.url))
            return;
          
          // get the data
          var req = new XMLHttpRequest();
          req.open("GET", "http://www.reddit.com/api/info.json?url=" + encodeURIComponent(tab.url), true);
          req.onreadystatechange = function ()
          {
            if (req.readyState == 4 && req.status == 200)
            {
              var dataFromReddit = JSON.parse(req.responseText);
              var count = 0, maxScore = 0, maxComments = 0, totalScore = 0, totalComments = 0;
              var debug = "";
              var list = [];
              
              // package data
              for (; entry = dataFromReddit.data.children[count]; count++)
              {
                //score|id|permalink|domain|created_utc|author|subreddit|num_comments|url|likes|...title
                list.push([entry.data.score, entry.data.name, entry.data.permalink, entry.data.domain, entry.data.created_utc * 1000, entry.data.author, entry.data.subreddit, entry.data.num_comments, entry.data.url, entry.data.likes, entry.data.title]);
                if (entry.data.score > maxScore)
                  maxScore = entry.data.score;
                if (entry.data.num_comments > maxComments)
                  maxComments = entry.data.num_comments;
                totalScore += entry.data.score;
                totalComments += entry.data.num_comments;
              }
              
              // sort items
              var sortFunctions = {
                score:function(a,b){return b[0]-a[0]},
                comments:function(a,b){return b[7]-a[7]},
                date:function(a,b){return b[4]-a[4]}
              };
              if (widget.preferences.listSorting != "nothing")
                list.sort(sortFunctions[widget.preferences.listSorting]);
              
              // save tab info
              for (var i = 0; i < list.length; i++)
                window.localStorage.setItem(i + "|" + tab.url, list[i].join("|"));
              window.localStorage.setItem(tab.url, [count, Date.now(), maxScore, maxComments, totalScore, totalComments].join("|"));
              
              // update badge
              updateBadge(tab.url);
            }
          }
          req.send();

          // get the usermod hash for authentication for voting
          var hash = new XMLHttpRequest();
          hash.open("GET", "http://www.reddit.com/api/me.json", true);
          hash.onreadystatechange = function()
          {
            if (hash.readyState == 4 && hash.status == 200)
            {
              var dataFromReddit = JSON.parse(hash.responseText);
              if (dataFromReddit.data)
                window.localStorage.setItem("modhash", dataFromReddit.data.modhash);
              else
                window.localStorage.setItem("modhash", "");
            }
          }
          hash.send();
        }
        else
        {
          reddited.disabled = true;
          reddited.badge.display = "none";
        }
      }
    </script>
  </head>
</html>
